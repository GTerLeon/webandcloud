<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TinyPet</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://unpkg.com/mithril/mithril.js"></script>
</head>
<body>

<script>    

// Model for Petition
var Petition = {
    list: [],
    myPetitions: [],
    create: function(title, description) {
        // Create petition
    },
    loadList: function() {
        // Load petitions from the server
    },
    loadMyPetitions: function() {
        // Load user petition
    }
};

// Petition Creation View
var PetitionCreateView = {
    title: '',
    description: '',
    tags: '',
    createPetition: function() {
        m.request({
            method: 'POST',
            url: '/_ah/api/myApi/v1/createPetition',
            body: {
                title: PetitionCreateView.title,
                description: PetitionCreateView.description,
                tags: PetitionCreateView.tags
            }
        })
        .then(function(result) {
            console.log('Petition created successfully', result);
            // Clear the form and provide feedback to the user as needed
            PetitionCreateView.title = '';
            PetitionCreateView.description = '';
            PetitionCreateView.tags = '';
            // Refresh the list of petitions or navigate the user to another view
        })
        .catch(function(error) {
            console.error('Error creating petition', error);
        });
    },
    view: function() {
        return m('div', [
            // ... Your existing view code ...
            m('button', {
                class: 'button is-link',
                onclick: PetitionCreateView.createPetition
            }, 'Create petition')
        ]);
    }
};

// My Petitions View
var MyPetitionsView = {
    list: [],
    loadMyPetitions: function() {
        // Assuming you have the user's ID and an endpoint to fetch signed petitions
        return m.request({
            method: "GET",
            url: "_ah/api/myApi/v1/userSignedPetitions/" + id_user
        })
        .then(function(result) {
            MyPetitionsView.list = result.items || [];
        })
        .catch(function(error) {
            console.error('Error loading my signed petitions:', error);
        });
    },
    oninit: function(vnode) {
        MyPetitionsView.loadMyPetitions();
    },
    view: function() {
        return m('div', [
            m('h2', 'Petitions I have signed'),
            m('div', {class: 'columns is-multiline'},
                MyPetitionsView.list.map(function(petition) {
                    return m('div', {class: 'column is-one-third'}, [
                        m('div', {class: 'box'}, [
                            m('h1', {class: 'title'}, petition.title),
                            m('p', {class: 'author'}, 'Author: ' + petition.author),
                            m('p', {class: 'description'}, petition.description),
                        ])
                    ]);
                })
            )
        ]);
    }
};

function signPetition(petitionId) {
    if (!isLoggedIn()) {
        redirectToLogin();
        return;
    }
    
    // Perform the API call to sign the petition
    m.request({
        method: 'POST',
        url: '/_ah/api/myApi/v1/signPetition/' + petitionId,
        // Add the body or headers if needed for user authentication
    })
    .then(function(result) {
        console.log('Signed petition successfully:', result);
        // Refresh the list of top petitions after signing
        TopPetitionsView.loadList();
    })
    .catch(function(error) {
        console.error('Error signing petition:', error);
    });
}

// Top Petitions View
var TopPetitionsView = {
    list: [],
    loadList: function() {
        // Make an HTTP request to your server's endpoint for the top 100 petitions
        m.request({
            method: "GET",
            url: "/_ah/api/myApi/v1/getTopPetitions"
        })
        .then(function(result) {
            TopPetitionsView.list = result.items || [];
        })
        .catch(function(error) {
            console.error('Error loading top petitions:', error);
        });
    },
    oninit: function(vnode) {
        TopPetitionsView.loadList();
    },
    view: function() {
        return m('div', [
            m('h2', 'Top 100 petitions'),
            m('div', 
                TopPetitionsView.list.map(function(petition) {
                    return m('div', {class: 'petition'},
                        m('h3', petition.title),
                        m('p', petition.description),
                        m('button', {
                            onclick: function() { signPetition(petition.id); }
                        }, 'Sign')
                    );
                })
            )
        ]);
    }
};

var App = {
    view: function() {
        return m('div', {class: 'container'}, [
            m('nav', {class: 'level'}, [
                m('div', {class: 'level-left'}, [
                    m('h1', {class: 'title'}, 'TinyPet')
                ]),
                m('div', {class: 'level-right'}, [
                    m('a', {class: 'button is-primary', href: 'glogin-new.html'}, 'Login')
                ])
            ]),
            m('div', {class: 'title is-ancestor'}, [
                m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(PetitionCreateView))),
                m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(TopPetitionsView))),
                m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(MyPetitionsView))),
            ])
        ]);
    }
};

m.mount(document.body, App);

</script>
</body>
</html>
